{% extends "base.html" %}

{% block title %}Dashboard - Construction Material Tracker{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-building"></i> Construction Material Tracker Dashboard</h1>
    <p>Welcome to your construction material management system</p>
</div>

<div class="dashboard-grid">
    <div class="stat-card">
        <div class="stat-value">₹{{ "%.2f"|format(total_cost) }}</div>
        <div class="stat-label">Total Cost</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ total_entries }}</div>
        <div class="stat-label">Total Entries</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ unique_sites }}</div>
        <div class="stat-label">Construction Sites</div>
    </div>
</div>

{% if recent_entries %}
<div class="card">
    <h2><i class="fas fa-clock"></i> Recent Entries</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Site</th>
                    <th>Material</th>
                    <th>Quantity</th>
                    <th>Cost</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in recent_entries %}
                <tr id="dashboard-row-{{ loop.index0 }}">
                    <td>{{ entry.Date.strftime('%Y-%m-%d') if entry.Date else 'N/A' }}</td>
                    <td>{{ entry.Site_Name }}</td>
                    <td>{{ entry.Material_Name }}</td>
                    <td>{{ entry.Quantity }} {{ entry.Unit }}</td>
                    <td>₹{{ "%.2f"|format(entry.Total_Cost) }}</td>
                    <td>
                        <button onclick="deleteEntryFromDashboard({{ loop.index0 }}, '{{ entry.Material_Name }}', '{{ entry.Site_Name }}')" 
                                class="btn btn-danger" style="padding: 0.3rem 0.6rem; font-size: 0.7rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="card">
    <h2><i class="fas fa-rocket"></i> Quick Actions</h2>
    <a href="/add_material" class="btn"><i class="fas fa-plus"></i> Add New Material</a>
    <a href="/material_usage" class="btn btn-secondary"><i class="fas fa-chart-pie"></i> Track Usage</a>
    <a href="/view_materials" class="btn btn-secondary"><i class="fas fa-list"></i> View All Materials</a>
    <a href="/analytics" class="btn btn-secondary"><i class="fas fa-chart-bar"></i> View Analytics</a>
</div>

<!-- Delete Confirmation Modal for Dashboard -->
<div id="dashboardDeleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; max-width: 400px; width: 90%;">
        <h3 style="margin-bottom: 1rem; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
        <p id="dashboardDeleteMessage" style="margin-bottom: 1.5rem; color: #333;"></p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeDashboardDeleteModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button id="dashboardConfirmDeleteBtn" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<!-- Success/Error Message for Dashboard -->
<div id="dashboardMessageAlert" style="display: none; position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 10px; z-index: 1001; max-width: 300px;">
</div>

<script>
let dashboardEntryToDelete = null;

function deleteEntryFromDashboard(entryId, materialName, siteName) {
    // Calculate the actual index (recent entries are the last 5, so we need to adjust)
    const totalEntries = {{ total_entries }};
    const actualIndex = totalEntries - 5 + entryId;
    
    dashboardEntryToDelete = actualIndex;
    document.getElementById('dashboardDeleteMessage').innerHTML = 
        `Are you sure you want to delete this entry?<br><br>` +
        `<strong>Material:</strong> ${materialName}<br>` +
        `<strong>Site:</strong> ${siteName}`;
    document.getElementById('dashboardDeleteModal').style.display = 'block';
}

function closeDashboardDeleteModal() {
    document.getElementById('dashboardDeleteModal').style.display = 'none';
    dashboardEntryToDelete = null;
}

function showDashboardMessage(message, isSuccess = true) {
    const alertDiv = document.getElementById('dashboardMessageAlert');
    alertDiv.style.display = 'block';
    alertDiv.style.background = isSuccess ? 
        'linear-gradient(135deg, #28a745, #20c997)' : 
        'linear-gradient(135deg, #dc3545, #fd7e14)';
    alertDiv.style.color = 'white';
    alertDiv.innerHTML = `<i class="fas fa-${isSuccess ? 'check' : 'exclamation-triangle'}"></i> ${message}`;
    
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 3000);
}

document.getElementById('dashboardConfirmDeleteBtn').addEventListener('click', function() {
    if (dashboardEntryToDelete !== null) {
        // Show loading state
        this.innerHTML = '<div class="loading"></div> Deleting...';
        this.disabled = true;
        
        fetch(`/delete_entry/${dashboardEntryToDelete}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDashboardMessage('Entry deleted successfully!', true);
                // Reload the page to update all statistics and recent entries
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showDashboardMessage('Error deleting entry: ' + data.message, false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showDashboardMessage('Error deleting entry. Please try again.', false);
        })
        .finally(() => {
            closeDashboardDeleteModal();
            this.innerHTML = '<i class="fas fa-trash"></i> Delete';
            this.disabled = false;
        });
    }
});

// Close modal when clicking outside
document.getElementById('dashboardDeleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDashboardDeleteModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDashboardDeleteModal();
    }
});
</script>
{% endblock %}