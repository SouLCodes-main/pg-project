{% extends "base.html" %}

{% block title %}Analytics - Construction Material Tracker{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-chart-bar"></i> Analytics Dashboard</h1>
    <p>Visualize your construction material spending patterns and trends</p>
</div>

{% if summary %}
<div class="card">
    <h2><i class="fas fa-info-circle"></i> Summary Statistics</h2>
    <div class="dashboard-grid">
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Total Spending:</strong> ₹{{ "%.2f"|format(summary.total_cost) }}
        </div>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Average Cost per Entry:</strong> ₹{{ "%.2f"|format(summary.avg_cost_per_entry) }}
        </div>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Most Expensive Site:</strong> {{ summary.most_expensive_site }}
        </div>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Most Used Material:</strong> {{ summary.most_used_material }}
        </div>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Date Range:</strong> {{ summary.date_range }}
        </div>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Remaining Material Value:</strong> ₹{{ "%.2f"|format(summary.total_remaining_value) }}
        </div>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Available Materials:</strong> {{ summary.available_materials }}
        </div>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <strong>Depleted Materials:</strong> {{ summary.depleted_materials }}
        </div>
    </div>
</div>
{% endif %}

{% if charts %}
<div class="chart-grid">
    {% if charts.cost_by_site %}
    <div class="chart-container">
        <h3><i class="fas fa-building"></i> Total Cost by Construction Site</h3>
        <img src="data:image/png;base64,{{ charts.cost_by_site }}" alt="Cost by Site Chart" style="max-width: 100%; height: auto;">
    </div>
    {% endif %}
    
    {% if charts.cost_over_time %}
    <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Cumulative Cost Over Time</h3>
        <img src="data:image/png;base64,{{ charts.cost_over_time }}" alt="Cost Over Time Chart" style="max-width: 100%; height: auto;">
    </div>
    {% endif %}
    
    {% if charts.material_distribution %}
    <div class="chart-container">
        <h3><i class="fas fa-chart-pie"></i> Cost Distribution by Material Type</h3>
        <img src="data:image/png;base64,{{ charts.material_distribution }}" alt="Material Distribution Chart" style="max-width: 100%; height: auto;">
    </div>
    {% endif %}
    
    {% if charts.monthly_spending %}
    <div class="chart-container">
        <h3><i class="fas fa-calendar-alt"></i> Monthly Spending</h3>
        <img src="data:image/png;base64,{{ charts.monthly_spending }}" alt="Monthly Spending Chart" style="max-width: 100%; height: auto;">
    </div>
    {% endif %}
    
    {% if charts.material_usage_status %}
    <div class="chart-container">
        <h3><i class="fas fa-chart-pie"></i> Material Status Distribution</h3>
        <img src="data:image/png;base64,{{ charts.material_usage_status }}" alt="Material Status Chart" style="max-width: 100%; height: auto;">
    </div>
    {% endif %}
    
    {% if charts.remaining_value_by_site %}
    <div class="chart-container">
        <h3><i class="fas fa-coins"></i> Remaining Material Value by Site</h3>
        <img src="data:image/png;base64,{{ charts.remaining_value_by_site }}" alt="Remaining Value Chart" style="max-width: 100%; height: auto;">
    </div>
    {% endif %}
</div>
{% else %}
<div class="card">
    <p style="text-align: center; color: #666; font-style: italic;">
        <i class="fas fa-info-circle"></i> No data available for analytics. Add some material records first!
    </p>
    <div style="text-align: center; margin-top: 1rem;">
        <a href="/add_material" class="btn"><i class="fas fa-plus"></i> Add Material</a>
    </div>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 15px; max-width: 400px; width: 90%;">
        <h3 style="margin-bottom: 1rem; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
        <p id="deleteMessage" style="margin-bottom: 1.5rem; color: #333;"></p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button id="confirmDeleteBtn" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<!-- Success/Error Message -->
<div id="messageAlert" style="display: none; position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 10px; z-index: 1001; max-width: 300px;">
</div>

<script>
let entryToDelete = null;

function deleteEntry(entryId, materialName, siteName) {
    entryToDelete = entryId;
    document.getElementById('deleteMessage').innerHTML = 
        `Are you sure you want to delete this entry?<br><br>` +
        `<strong>Material:</strong> ${materialName}<br>` +
        `<strong>Site:</strong> ${siteName}`;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    entryToDelete = null;
}

function showMessage(message, isSuccess = true) {
    const alertDiv = document.getElementById('messageAlert');
    alertDiv.style.display = 'block';
    alertDiv.style.background = isSuccess ? 
        'linear-gradient(135deg, #28a745, #20c997)' : 
        'linear-gradient(135deg, #dc3545, #fd7e14)';
    alertDiv.style.color = 'white';
    alertDiv.innerHTML = `<i class="fas fa-${isSuccess ? 'check' : 'exclamation-triangle'}"></i> ${message}`;
    
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 3000);
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (entryToDelete !== null) {
        // Show loading state
        this.innerHTML = '<div class="loading"></div> Deleting...';
        this.disabled = true;
        
        fetch(`/delete_entry/${entryToDelete}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from the table
                const row = document.getElementById(`row-${entryToDelete}`);
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        row.remove();
                        // Update the summary if needed
                        location.reload(); // Simple way to update counts and totals
                    }, 300);
                }
                showMessage('Entry deleted successfully!', true);
            } else {
                showMessage('Error deleting entry: ' + data.message, false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error deleting entry. Please try again.', false);
        })
        .finally(() => {
            closeDeleteModal();
            this.innerHTML = '<i class="fas fa-trash"></i> Delete';
            this.disabled = false;
        });
    }
});

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDeleteModal();
    }
});
</script>
{% endblock %}